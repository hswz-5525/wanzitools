{% extends "base.html" %}

{% block title %}Docker镜像管理{% endblock %}

{% block extra_style %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        padding: 20px;
        background-color: #f5f7fa;
        color: #2c3e50;
    }

    h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        font-size: 2.2em;
    }

    .navigation {
        display: flex;
        justify-content: space-between;
        background: white;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-left {
        flex: 0 0 auto;
    }

    .nav-right {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .home-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: #2ecc71;
        color: white !important;
        padding: 8px 15px;
        border-radius: 4px;
        transition: all 0.2s;
        text-decoration: none;
    }

    .home-btn:hover {
        background-color: #27ae60;
        transform: translateY(-2px);
    }

    .home-btn i {
        font-size: 1.1em;
    }

    .toolbar {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .toolbar button {
        padding: 8px 15px;
        background-color: #f8f9fa;
        color: #2c3e50;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .toolbar button:hover {
        background-color: #e9ecef;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    th {
        background-color: #3498db;
        color: white;
        padding: 12px;
        text-align: left;
    }

    td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }

    tr:hover {
        background-color: #f8f9fa;
    }

    .controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    button:hover {
        background-color: #2980b9;
    }

    input[type="text"],
    input[type="number"] {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-right: 10px;
    }

    .search-box {
        margin: 20px 0;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-box form {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .search-box input[type="text"] {
        flex: 1;
    }

    /* 添加工具提示样式 */
    [title] {
        position: relative;
    }

    [title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
    }

    .unused-image {
        background-color: #fdf0ed;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .tag {
        background-color: #e8f4f8;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
        color: #2980b9;
        display: inline-flex;
        align-items: center;
    }

    /* 状态指示器样式 */
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }

    .status-running {
        background-color: #2ecc71;
        box-shadow: 0 0 6px #2ecc71;
    }

    .status-stopped {
        background-color: #95a5a6;
        box-shadow: 0 0 6px #95a5a6;
    }

    /* 镜像信息样式 */
    .image-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .image-name {
        font-weight: 500;
        color: #2c3e50;
    }

    .image-id {
        font-family: monospace;
        color: #7f8c8d;
        font-size: 0.9em;
    }

    /* 进度条样式 */
    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        margin: 15px 0;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background-color: #2ecc71;
        width: 0;
        transition: width 0.3s ease;
    }

    .progress-text, .progress-size {
        text-align: center;
        margin: 10px 0;
        color: #666;
    }

    /* 推送按钮样式 */
    .push-btn {
        background-color: #2ecc71;
        color: white;
    }

    /* 推送表单样式 */
    .push-form {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 20px 0;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #666;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    /* 代理测试结果样式 */
    .proxy-test-result {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        display: none;
    }

    .proxy-test-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .proxy-test-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .test-proxy-btn {
        background-color: #17a2b8;
        color: white;
        margin-top: 10px;
    }

    /* 删除确认对话框样式 */
    #delete-modal .delete-summary {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: center;
    }

    .highlight {
        color: #e74c3c;
        font-weight: bold;
        font-size: 1.2em;
    }

    .delete-warning {
        color: #e74c3c;
        margin: 15px 0;
        font-weight: 500;
    }

    .upload-btn {
        background-color: #3498db;
        color: white;
    }

    .upload-btn:hover {
        background-color: #2980b9;
    }

    .file-info {
        margin-top: 8px;
        font-size: 0.9em;
        color: #666;
    }

    .upload-form {
        margin: 20px 0;
    }

    .upload-form input[type="file"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
    }

    .upload-form input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    #upload-progress {
        margin: 20px 0;
    }

    .upload-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
    }

    .tab-btn {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        color: #666;
        position: relative;
    }

    .tab-btn.active {
        color: #3498db;
        font-weight: 500;
    }

    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #3498db;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .upload-form input[type="url"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .export-btn {
        background-color: #27ae60;
        color: white;
    }

    .export-btn:hover {
        background-color: #219a52;
    }

    .export-summary {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: center;
    }

    #export-progress {
        margin: 20px 0;
    }

    .status-text {
        margin-top: 10px;
        color: #666;
        font-size: 0.9em;
        text-align: center;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 15px 0;
    }

    .progress-fill {
        height: 100%;
        background-color: #27ae60;
        width: 0;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        color: #666;
        margin: 10px 0;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: 500;
    }

    .action-btn i {
        font-size: 1.1em;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-content {
        position: relative;
        background-color: white;
        margin: 50px auto;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: move;
    }

    .modal-header {
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        cursor: move;
    }

    .modal-header h3 {
        margin: 0;
        display: inline-block;
    }

    /* 确保内容区域可以滚动 */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
    }

    /* 统一对话框按钮样式 */
    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-buttons button {
        min-width: 100px;
    }

    .modal-buttons button:first-child {
        background-color: #95a5a6;
    }

    .modal-buttons button:last-child {
        background-color: #3498db;
    }

    /* 修改按钮颜色 */
    .push-btn {
        background-color: #f39c12;
    }

    .push-btn:hover {
        background-color: #d68910;
    }

    .export-btn {
        background-color: #27ae60;
    }

    .export-btn:hover {
        background-color: #219a52;
    }

    .delete-btn {
        background-color: #e74c3c;
    }

    .delete-btn:hover {
        background-color: #c0392b;
    }

    .config-btn {
        background-color: #9b59b6;
    }

    .config-btn:hover {
        background-color: #8e44ad;
    }

    .test-btn {
        background-color: #17a2b8;
        color: white;
        margin-top: 10px;
    }

    .test-result {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        display: none;
    }

    .test-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .test-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .config-form {
        margin: 20px 0;
    }

    .config-form select,
    .config-form input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .push-form {
        margin: 20px 0;
    }

    .push-form .form-group {
        margin-bottom: 15px;
    }

    .push-form label {
        display: block;
        margin-bottom: 5px;
        color: #666;
    }

    .push-form input,
    .push-form select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .help-text {
        font-size: 0.9em;
        color: #666;
        margin-top: 4px;
    }

    #push-progress {
        margin: 20px 0;
    }

    .test-proxy-btn {
        width: 100%;
        margin: 10px 0;
    }

    .proxy-test-result {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        display: none;
    }

    .upload-status {
        text-align: center;
        color: #3498db;
        margin-top: 10px;
        font-size: 0.9em;
    }

    .fa-spin {
        margin-right: 8px;
    }

    /* 禁用状态的按钮样式 */
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .edit-tag-btn {
        background: none;
        border: none;
        color: #3498db;
        cursor: pointer;
        padding: 2px 6px;
        margin-left: 8px;
    }

    .edit-tag-btn:hover {
        color: #2980b9;
    }

    .tag-form {
        margin: 20px 0;
    }

    .current-tags {
        margin: 10px 0;
    }

    .tag-btn {
        background-color: #3498db;
        color: white;
    }

    .tag-btn:hover {
        background-color: #2980b9;
    }

    .version-info {
        text-align: right;
        color: #666;
        font-size: 0.8em;
        margin-bottom: 20px;
        padding: 5px 10px;
    }

    .version-info span {
        background-color: #f8f9fa;
        padding: 3px 8px;
        border-radius: 4px;
        border: 1px solid #eee;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        align-items: center;
    }

    .tag {
        background-color: #e8f4f8;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
        color: #2980b9;
        display: inline-flex;
        align-items: center;
    }

    .edit-tag-btn {
        background: none;
        border: none;
        color: #3498db;
        cursor: pointer;
        padding: 2px 6px;
        margin-left: 8px;
    }

    .edit-tag-btn:hover {
        color: #2980b9;
    }

    .current-tags {
        margin: 10px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .delete-tag-btn {
        background: none;
        border: none;
        color: #e74c3c;
        cursor: pointer;
        padding: 0 4px;
        margin-left: 6px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .tag:hover .delete-tag-btn {
        opacity: 1;
    }

    .delete-tag-btn:hover {
        color: #c0392b;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        background-color: #e8f4f8;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
        color: #2980b9;
        margin: 2px;
    }

    .status-text {
        text-align: center;
        color: #3498db;
        margin: 20px 0;
        font-size: 0.9em;
    }

    .fa-spin {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
    
    <!-- 工具栏 -->
    <div class="toolbar">
        <button onclick="selectAll()">
            <i class="fas fa-check-square"></i> {{ lang.buttons.select_all }}
        </button>
        <button onclick="deselectAll()">
            <i class="fas fa-square"></i> {{ lang.buttons.deselect_all }}
        </button>
        <button onclick="selectUnused()">
            <i class="fas fa-filter"></i> {{ lang.docker.buttons.select_unused }}
        </button>
        <button class="action-btn" onclick="showAddModal()">
            <i class="fas fa-plus"></i> {{ lang.docker.buttons.add }}
        </button>
        <button class="action-btn push-btn" onclick="showPushModal()">
            <i class="fas fa-upload"></i> {{ lang.docker.buttons.push }}
        </button>
        <button class="action-btn export-btn" onclick="showExportModal()">
            <i class="fas fa-download"></i> {{ lang.docker.buttons.export }}
        </button>
        <button class="action-btn delete-btn" onclick="showDeleteModal()">
            <i class="fas fa-trash"></i> {{ lang.docker.buttons.delete }}
        </button>
        <button class="action-btn config-btn" onclick="showConfigModal()">
            <i class="fas fa-cog"></i> {{ lang.docker.buttons.config }}
        </button>
    </div>

    <!-- 镜像列表 -->
    <form id="image-form">
        <table class="image-table">
            <thead>
                <tr>
                    <th style="width: 50px">{{ lang.docker.table.select }}</th>
                    <th>{{ lang.docker.table.info }}</th>
                    <th>{{ lang.docker.table.tags }}</th>
                    <th>{{ lang.docker.table.size }}</th>
                    <th>{{ lang.docker.table.created }}</th>
                    <th>{{ lang.docker.table.status }}</th>
                </tr>
            </thead>
            <tbody>
                {% for image in images %}
                <tr class="{{ 'unused-image' if not image.is_used }}">
                    <td>
                        <input type="checkbox" name="image_ids" value="{{ image.id }}" 
                               class="image-checkbox" data-used="{{ image.is_used|lower }}">
                    </td>
                    <td>
                        <div class="image-info">
                            <span class="image-name">{{ image.name }}</span>
                            <span class="image-id">ID: {{ image.short_id }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="tag-list">
                            {% for tag in image.tags %}
                            <span class="tag">
                                <i class="fas fa-tag" style="margin-right: 4px;"></i>
                                {{ tag }}
                            </span>
                            {% endfor %}
                            <button type="button" class="edit-tag-btn" 
                                    onclick='showTagModal("{{ image.id }}", {{ image.tags|tojson|safe }})'>
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                    <td>{{ image.size }}</td>
                    <td>{{ image.created }}</td>
                    <td>
                        <span class="status-indicator {{ 'status-running' if image.is_used else 'status-stopped' }}"></span>
                        {{ lang.docker.status.in_use if image.is_used else lang.docker.status.unused }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

    <!-- 修改删除确认对话框 -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>{{ lang.docker.dialogs.delete.title }}</h3>
                <button type="button" class="close-btn" onclick="closeModal('delete-modal')">×</button>
            </div>
            <div class="modal-body">
                <p>{{ lang.docker.dialogs.delete.message }}</p>
                <div class="delete-summary">
                    <p>{{ lang.docker.dialogs.delete.selected }}: <span class="highlight" id="selected-count">0</span></p>
                    <p>{{ lang.docker.dialogs.delete.total_size }}: <span class="highlight" id="total-size">0 MB</span></p>
                </div>
                <div id="delete-status" class="status-text" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> 正在删除镜像...
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('delete-modal')">{{ lang.docker.dialogs.delete.cancel }}</button>
                <button class="delete-btn" onclick="confirmDelete()">{{ lang.docker.dialogs.delete.confirm }}</button>
            </div>
        </div>
    </div>

    <!-- 推送确认对话框 -->
    <div id="push-modal" class="modal">
        <div class="modal-content" id="push-modal-content">
            <div class="modal-header">
                <h3>{{ lang.docker.dialogs.push.title }}</h3>
            </div>
            <div class="push-form">
                <!-- 仓库选择 -->
                <div class="form-group">
                    <label>{{ lang.docker.dialogs.push.target }}：</label>
                    <select id="registry-type" onchange="toggleRegistryFields()">
                        <option value="dockerhub">DockerHub</option>
                        <option value="aliyun">{{ lang.docker.dialogs.push.aliyun.name }}</option>
                    </select>
                </div>

                <!-- DockerHub 认证信息 -->
                <div id="dockerhub-fields">
                    <div class="form-group">
                        <label>DockerHub 用户名：</label>
                        <input type="text" id="docker-username" placeholder="输入用户名">
                    </div>
                    <div class="form-group">
                        <label>DockerHub 密码：</label>
                        <input type="password" id="docker-password" placeholder="输入密码">
                    </div>
                </div>

                <!-- 阿里云认证信息 -->
                <div id="aliyun-fields" style="display: none;">
                    <div class="form-group">
                        <label>阿里云容器镜像实例：</label>
                        <select id="aliyun-region">
                            <option value="registry.cn-hangzhou.aliyuncs.com">华东1（杭州）</option>
                            <option value="registry.cn-shanghai.aliyuncs.com">华东2（上海）</option>
                            <option value="registry.cn-beijing.aliyuncs.com">华北2（北京）</option>
                            <option value="registry.cn-shenzhen.aliyuncs.com">华南1（深圳）</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>命名空间：</label>
                        <input type="text" id="aliyun-namespace" placeholder="输入命名空间">
                    </div>
                    <div class="form-group">
                        <label>访问凭证：</label>
                        <input type="text" id="aliyun-username" placeholder="输入访问凭证用户名">
                    </div>
                    <div class="form-group">
                        <label>密码：</label>
                        <input type="password" id="aliyun-password" placeholder="输入访问凭证密码">
                    </div>
                </div>

                <!-- 标签管理部分 -->
                <div class="form-group full-width">
                    <label>新标签格式：</label>
                    <input type="text" id="tag-format" placeholder="例如: {namespace}/{imagename}:{version}">
                    <p class="help-text" id="tag-format-help">
                        DockerHub格式: {username}/{imagename}:{version}<br>
                        阿里云格式: {region}/{namespace}/{imagename}:{version}
                    </p>
                </div>

                <!-- 代理设置部分 -->
                <div class="form-group">
                    <label>代理类型（可选）：</label>
                    <select id="proxy-type">
                        <option value="">不使用代理</option>
                        <option value="http">HTTP代理</option>
                        <option value="socks5">SOCKS5代理</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>代理服务器地址：</label>
                    <input type="text" id="proxy-server" placeholder="例如: http://proxy.example.com:8080">
                </div>
                <button type="button" class="test-proxy-btn" onclick="testProxy()">测试代理连接</button>
                <div id="proxy-test-result" class="proxy-test-result"></div>

                <!-- 进度显示部分 -->
                <div id="push-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="progress-text">推送进度: <span id="push-percent">0</span>%</p>
                    <p class="status-text">正在处理: <span id="current-image">-</span></p>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('push-modal')">{{ lang.buttons.cancel }}</button>
                <button class="push-btn" onclick="pushImages()">开始推送</button>
            </div>
        </div>
    </div>

    <!-- 添加上传对话框 -->
    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <h3>添加镜像</h3>
            <div class="upload-form">
                <!-- 添加选项卡 -->
                <div class="upload-tabs">
                    <button class="tab-btn active" onclick="switchTab('file-tab')">本地文件</button>
                    <button class="tab-btn" onclick="switchTab('remote-tab')">远程镜像</button>
                </div>
                
                <!-- 本地文件上传表单 -->
                <div id="file-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="image-file">选择镜像文件</label>
                        <input type="file" id="image-file" onchange="handleFileSelect(event)">
                        <p class="help-text">支持通过 docker save 命令保存的镜像文件</p>
                        <p class="file-info" id="file-info"></p>
                    </div>
                    <div class="form-group">
                        <label for="image-name-local">自定义镜像名称（可选）</label>
                        <input type="text" id="image-name-local" placeholder="例如: myapp">
                    </div>
                    <div class="form-group">
                        <label for="image-tag-local">自定义标签（可选，默认latest）</label>
                        <input type="text" id="image-tag-local" placeholder="例如: v1.0">
                    </div>
                </div>
                
                <!-- 远程镜像拉取表单 -->
                <div id="remote-tab" class="tab-content">
                    <!-- 添加选项卡 -->
                    <div class="form-group">
                        <label>选择镜像来源：</label>
                        <select id="image-source" onchange="toggleImageSource()">
                            <option value="registry">镜像仓库</option>
                            <option value="url">远程链接</option>
                        </select>
                    </div>
                    
                    <!-- 镜像仓库输入 -->
                    <div id="registry-input">
                        <div class="form-group">
                            <label for="registry-url">仓库地址 (可选)</label>
                            <input type="text" id="registry-url" placeholder="例如: registry.example.com">
                            <p class="help-text">留空则默认使用 Docker Hub</p>
                        </div>
                        <div class="form-group">
                            <label for="image-name">镜像名称</label>
                            <input type="text" id="image-name" placeholder="例如: nginx, ubuntu">
                        </div>
                        <div class="form-group">
                            <label for="image-tag-remote">标签 (可选)</label>
                            <input type="text" id="image-tag-remote" placeholder="例如: latest, 1.19">
                        </div>
                    </div>
                    
                    <!-- 远程链接输入 -->
                    <div id="url-input" style="display: none;">
                        <div class="form-group">
                            <label for="image-url">镜像文件链接</label>
                            <input type="url" id="image-url" placeholder="输入镜像文件的下载链接">
                        </div>
                        <div class="form-group">
                            <label for="image-name-url">自定义镜像名称（可选）</label>
                            <input type="text" id="image-name-url" placeholder="例如: myapp">
                        </div>
                        <div class="form-group">
                            <label for="image-tag-url">自定义标签（可选，默认latest）</label>
                            <input type="text" id="image-tag-url" placeholder="例如: v1.0">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('upload-modal')">取消</button>
                <button class="upload-btn" onclick="handleImageAdd()" id="upload-button">确认添加</button>
                <div id="upload-status" class="upload-status" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> 镜像添加中...
                </div>
            </div>
        </div>
    </div>

    <!-- 修改导出确认对话框 -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <h3>确认导出</h3>
            <div class="export-summary">
                <p>已选择 <span id="export-count" class="highlight">0</span> 个镜像</p>
                <p>总计大小：<span id="export-size" class="highlight">0 MB</span></p>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('export-modal')">取消</button>
                <button class="export-btn" onclick="startExport()">确认导出</button>
            </div>
        </div>
    </div>

    <!-- 添加配置对话框 -->
    <div id="config-modal" class="modal">
        <div class="modal-content">
            <h3>{{ lang.docker.buttons.config }}</h3>
            <div class="config-form">
                <!-- 预设镜像源选择 -->
                <div class="form-group">
                    <label>选择预设镜像源：</label>
                    <select id="preset-registry" onchange="handlePresetChange()">
                        <option value="">自定义</option>
                        <option value="https://registry.docker-cn.com">Docker中国区</option>
                        <option value="https://hub-mirror.c.163.com">网易镜像</option>
                        <option value="https://mirror.baidubce.com">百度镜像</option>
                        <option value="https://mirror.ccs.tencentyun.com">腾讯云镜像</option>
                        <option value="https://registry.cn-hangzhou.aliyuncs.com">阿里云镜像</option>
                    </select>
                </div>

                <!-- 自定义镜像源配置 -->
                <div class="form-group">
                    <label>镜像源地址：</label>
                    <input type="text" id="registry-address" placeholder="例如: https://registry.example.com">
                </div>

                <!-- 测试连接部分 -->
                <div class="form-group">
                    <button type="button" class="test-btn" onclick="testRegistry()">
                        <i class="fas fa-vial"></i> {{ lang.buttons.test }}
                    </button>
                    <div id="test-result" class="test-result"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('config-modal')">{{ lang.buttons.cancel }}</button>
                <button class="config-btn" onclick="saveRegistryConfig()">保存配置</button>
            </div>
        </div>
    </div>

    <!-- 修改标签对话框 -->
    <div id="tag-modal" class="modal">
        <div class="modal-content">
            <h3>{{ lang.dialogs.tag.title }}</h3>
            <div class="tag-form">
                <div class="form-group">
                    <label>{{ lang.dialogs.tag.current }}：</label>
                    <div id="current-tags" class="current-tags"></div>
                </div>
                <div class="form-group">
                    <label>{{ lang.dialogs.tag.new }}：</label>
                    <input type="text" id="new-tag" placeholder="{{ lang.dialogs.tag.placeholder }}">
                    <p class="help-text">{{ lang.dialogs.tag.help }}</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('tag-modal')">{{ lang.buttons.cancel }}</button>
                <button class="tag-btn" onclick="updateTag()">{{ lang.buttons.save }}</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function selectAll() {
        document.querySelectorAll('.image-checkbox').forEach(cb => cb.checked = true);
    }

    function deselectAll() {
        document.querySelectorAll('.image-checkbox').forEach(cb => cb.checked = false);
    }

    function selectUnused() {
        document.querySelectorAll('.image-checkbox').forEach(cb => {
            cb.checked = cb.dataset.used === 'false';
        });
    }

    function showAddModal() {
        document.getElementById('upload-modal').style.display = 'block';
    }

    function showPushModal() {
        const selected = document.querySelectorAll('.image-checkbox:checked');
        if (selected.length === 0) {
            alert('请先选要推送的镜像');
            return;
        }
        document.getElementById('push-modal').style.display = 'block';
        document.getElementById('push-count').textContent = selected.length;
        
        // 重置对话框位置
        const modalContent = document.getElementById('push-modal-content');
        modalContent.style.transform = 'translate(0, 0)';
        
        // 初始化拖动功能
        makeDraggable('push-modal');
    }

    function showExportModal() {
        const selected = document.querySelectorAll('.image-checkbox:checked');
        if (selected.length === 0) {
            alert('请先选择要导出的镜像');
            return;
        }

        // 计算选中的镜像数量和总大小
        let totalSize = 0;
        selected.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const sizeText = row.querySelector('td:nth-child(4)').textContent;
            const size = parseFloat(sizeText);
            if (!isNaN(size)) {
                totalSize += size;
            }
        });

        // 更新确认对话框中的统计信息
        document.getElementById('export-count').textContent = selected.length;
        document.getElementById('export-size').textContent = totalSize.toFixed(2);
        
        // 显示确认对话框
        const exportModal = document.getElementById('export-modal');
        exportModal.style.display = 'block';
    }

    function showDeleteModal() {
        const selected = document.querySelectorAll('.image-checkbox:checked');
        if (selected.length === 0) {
            alert('请先选择要删除的镜像');
            return;
        }

        // 计算选中的镜像数量和总大小
        let totalSize = 0;
        selected.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const sizeText = row.querySelector('td:nth-child(4)').textContent;
            const size = parseFloat(sizeText);
            if (!isNaN(size)) {
                totalSize += size;
            }
        });

        // 更新确认对话框中的统计信息
        document.getElementById('selected-count').textContent = selected.length;
        document.getElementById('total-size').textContent = totalSize.toFixed(2) + ' MB';
        
        // 显示对话框
        document.getElementById('delete-modal').style.display = 'block';
    }

    // 添加关闭对话框的通用函数
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
            modalContent.style.transform = 'translate(0, 0)';
        }
        modal.style.display = 'none';
    }

    // 添加点击对话框外关闭的功能
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    async function confirmDelete() {
        try {
            const form = document.getElementById('image-form');
            const formData = new FormData(form);
            
            // 显示等待状态，隐藏按钮
            document.querySelector('#delete-modal .modal-buttons').style.display = 'none';
            document.getElementById('delete-status').style.display = 'block';

            const response = await fetch('{{ url_for("image.delete_docker_images") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.status === 'success' || result.status === 'partial') {
                if (result.errors && result.errors.length > 0) {
                    alert(`部分镜像删除成功，但有以下错误：\n${result.errors.map(e => e.message).join('\n')}`);
                } else {
                    alert('删除成功');
                }
                location.reload();
            } else {
                alert('删除失败: ' + result.message);
            }
        } catch (error) {
            alert('删除出错: ' + error.message);
        } finally {
            // 恢复对话框状态
            document.querySelector('#delete-modal .modal-buttons').style.display = 'flex';
            document.getElementById('delete-status').style.display = 'none';
            closeModal('delete-modal');
        }
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const size = (file.size / (1024 * 1024)).toFixed(2);
            document.getElementById('file-info').textContent = 
                `文件名: ${file.name}\n大小: ${size} MB`;
            document.getElementById('total-size').textContent = size;
        }
    }

    function switchTab(tabId) {
        // 移除所有标签页和按钮的活动状态
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        // 激活选中的标签页和按钮
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        
        // 如果切换到远程镜像标签页，初始化显示状态
        if (tabId === 'remote-tab') {
            toggleImageSource();
        }
    }

    function toggleImageSource() {
        const source = document.getElementById('image-source').value;
        const registryInput = document.getElementById('registry-input');
        const urlInput = document.getElementById('url-input');
        
        if (source === 'registry') {
            registryInput.style.display = 'block';
            urlInput.style.display = 'none';
        } else {
            registryInput.style.display = 'none';
            urlInput.style.display = 'block';
        }
    }

    async function handleImageAdd() {
        const activeTab = document.querySelector('.tab-btn.active');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');
        const modalButtons = document.querySelector('#upload-modal .modal-buttons');
        
        try {
            // 禁用按钮并显示状态
            uploadButton.disabled = true;
            modalButtons.querySelector('button:first-child').disabled = true;
            uploadStatus.style.display = 'block';
            
            if (activeTab.textContent === '本地文件') {
                // 处理本地文件上传
                const fileInput = document.getElementById('image-file');
                const imageName = document.getElementById('image-name-local').value.trim();
                const imageTag = document.getElementById('image-tag-local').value.trim();
                
                if (!fileInput.files[0]) {
                    alert('请选择镜像文件');
                    return;
                }
                
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                formData.append('upload_type', 'file');
                if (imageName) {
                    formData.append('image_name', imageName);
                    formData.append('tag', imageTag || 'latest');
                }
                
                await uploadLocalImage(formData);
            } else {
                // 处理远程镜像
                const source = document.getElementById('image-source').value;
                
                if (source === 'registry') {
                    const registryUrl = document.getElementById('registry-url').value.trim();
                    const imageName = document.getElementById('image-name').value.trim();
                    const imageTag = document.getElementById('image-tag-remote').value.trim() || 'latest';
                    
                    if (!imageName) {
                        alert('请输入镜像名称');
                        return;
                    }
                    
                    await pullRegistryImage(registryUrl, imageName, imageTag);
                } else {
                    const imageUrl = document.getElementById('image-url').value.trim();
                    const imageName = document.getElementById('image-name-url').value.trim();
                    const imageTag = document.getElementById('image-tag-url').value.trim();
                    
                    if (!imageUrl) {
                        alert('请输入镜像文件链接');
                        return;
                    }
                    
                    await pullUrlImage(imageUrl, imageName, imageTag);
                }
            }
        } catch (error) {
            alert('操作失败：' + error.message);
        } finally {
            // 恢复按钮状态并隐藏提示
            uploadButton.disabled = false;
            modalButtons.querySelector('button:first-child').disabled = false;
            uploadStatus.style.display = 'none';
            closeModal('upload-modal');
        }
    }

    async function uploadLocalImage(formData) {
        const response = await fetch('{{ url_for("image.upload_docker_image") }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert('镜像上传成功');
            location.reload();
        } else {
            throw new Error(result.message);
        }
    }

    async function pullRegistryImage(registry, name, tag) {
        const response = await fetch('{{ url_for("image.pull_docker_image") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                registry_url: registry,
                image_name: name,
                tag: tag
            })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert('镜像拉取成功');
            location.reload();
        } else {
            throw new Error(result.message);
        }
    }

    async function pullUrlImage(url, imageName, imageTag) {
        const response = await fetch('{{ url_for("image.pull_docker_image") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                image_url: url,
                image_name: imageName,
                tag: imageTag || 'latest'
            })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert('镜像拉取成功');
            location.reload();
        } else {
            throw new Error(result.message);
        }
    }

    async function startExport() {
        try {
            const form = document.getElementById('image-form');
            const formData = new FormData(form);
            
            // 显示加载状态
            document.querySelector('#export-modal .modal-buttons').style.display = 'none';
            document.querySelector('#export-modal .export-summary').innerHTML += '<p class="status-text"><i class="fas fa-spinner fa-spin"></i> 正在导出镜像...</p>';

            const response = await fetch('{{ url_for("image.export_docker_images") }}', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message || '导出失败');
            }

            // 获取文件名
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'docker_images.tar';
            if (contentDisposition) {
                const matches = /filename=(.+)/.exec(contentDisposition);
                if (matches && matches[1]) {
                    filename = matches[1].replace(/["']/g, '');
                }
            }

            // 下载文件
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            closeModal('export-modal');
        } catch (error) {
            alert('导出错误: ' + error.message);
        } finally {
            // 恢复对话框状态
            document.querySelector('#export-modal .modal-buttons').style.display = 'flex';
            const statusText = document.querySelector('#export-modal .status-text');
            if (statusText) {
                statusText.remove();
            }
        }
    }

    function showConfigModal() {
        document.getElementById('config-modal').style.display = 'block';
        // 加载当前配置
        loadCurrentConfig();
    }

    function handlePresetChange() {
        const preset = document.getElementById('preset-registry').value;
        const addressInput = document.getElementById('registry-address');
        addressInput.value = preset;
    }

    async function loadCurrentConfig() {
        try {
            const response = await fetch('{{ url_for("image.get_registry_config") }}');
            const config = await response.json();
            if (config.status === 'success') {
                document.getElementById('registry-address').value = config.registry || '';
                // 尝试匹配预设值
                const presetSelect = document.getElementById('preset-registry');
                const options = Array.from(presetSelect.options);
                const matchingOption = options.find(option => option.value === config.registry);
                if (matchingOption) {
                    matchingOption.selected = true;
                } else {
                    presetSelect.value = '';
                }
            }
        } catch (error) {
            console.error('加载配置失败:', error);
        }
    }

    async function testRegistry() {
        const registry = document.getElementById('registry-address').value.trim();
        if (!registry) {
            alert('请输入镜像源地址');
            return;
        }

        const testResult = document.getElementById('test-result');
        testResult.style.display = 'block';
        testResult.className = 'test-result';
        testResult.textContent = '正在测试连接...';

        try {
            const response = await fetch('{{ url_for("image.test_registry") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ registry })
            });

            const result = await response.json();
            if (result.status === 'success') {
                testResult.className = 'test-result test-success';
                testResult.textContent = '连接成功！' + result.message;
            } else {
                testResult.className = 'test-result test-error';
                testResult.textContent = '连接失败：' + result.error;
            }
        } catch (error) {
            testResult.className = 'test-result test-error';
            testResult.textContent = '测试出错：' + error.message;
        }
    }

    async function saveRegistryConfig() {
        const registry = document.getElementById('registry-address').value.trim();
        
        try {
            const response = await fetch('{{ url_for("image.save_registry_config") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ registry })
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert('配置保存成功');
                closeModal('config-modal');
            } else {
                alert('保存失败：' + result.message);
            }
        } catch (error) {
            alert('保存出错：' + error.message);
        }
    }

    async function testProxy() {
        const proxyType = document.getElementById('proxy-type').value;
        const proxyServer = document.getElementById('proxy-server').value;

        if (!proxyType || !proxyServer) {
            alert('请选择代理类型并输入代理服务器地址');
            return;
        }

        const testResult = document.getElementById('proxy-test-result');
        testResult.style.display = 'block';
        testResult.className = 'proxy-test-result';
        testResult.textContent = '正在测试连接...';

        try {
            const response = await fetch('{{ url_for("image.test_proxy") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    proxy_type: proxyType,
                    proxy_server: proxyServer
                })
            });

            const result = await response.json();
            if (result.status === 'success') {
                testResult.className = 'proxy-test-result test-success';
                testResult.textContent = '连接成功！' + result.message;
            } else {
                testResult.className = 'proxy-test-result test-error';
                testResult.textContent = '连接失败：' + result.error;
            }
        } catch (error) {
            testResult.className = 'proxy-test-result test-error';
            testResult.textContent = '测试出错：' + error.message;
        }
    }

    async function pushImages() {
        const registryType = document.getElementById('registry-type').value;
        const tagFormat = document.getElementById('tag-format').value.trim();
        const proxyType = document.getElementById('proxy-type').value;
        const proxyServer = document.getElementById('proxy-server').value.trim();

        let credentials = {};
        if (registryType === 'dockerhub') {
            const username = document.getElementById('docker-username').value.trim();
            const password = document.getElementById('docker-password').value;
            
            if (!username || !password) {
                alert('请填写完整的DockerHub认证信息');
                return;
            }
            
            credentials = {
                username: username,
                password: password
            };
        } else {
            const region = document.getElementById('aliyun-region').value;
            const namespace = document.getElementById('aliyun-namespace').value.trim();
            const username = document.getElementById('aliyun-username').value.trim();
            const password = document.getElementById('aliyun-password').value;
            
            if (!namespace || !username || !password) {
                alert('请填写完整的阿里云认证信息');
                return;
            }
            
            credentials = {
                registry_type: 'aliyun',
                region: region,
                namespace: namespace,
                username: username,
                password: password
            };
        }

        if (!tagFormat) {
            alert('请填写标签格式');
            return;
        }

        // 显示进度区域，隐藏按钮
        document.getElementById('push-progress').style.display = 'block';
        document.querySelector('#push-modal .modal-buttons').style.display = 'none';

        try {
            const form = document.getElementById('image-form');
            const formData = new FormData(form);
            const imageIds = formData.getAll('image_ids');

            const response = await fetch('{{ url_for("image.push_docker_images") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_ids: imageIds,
                    registry_type: registryType,
                    credentials: credentials,
                    tag_format: tagFormat,
                    proxy_type: proxyType,
                    proxy_server: proxyServer
                })
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert('推送成功');
                location.reload();
            } else {
                alert('推送失败: ' + result.message);
            }
        } catch (error) {
            alert('推送出错: ' + error.message);
        } finally {
            closeModal('push-modal');
        }
    }

    let currentImageId = null;

    function showTagModal(imageId, tags) {
        currentImageId = imageId;
        const tagModal = document.getElementById('tag-modal');
        const currentTags = document.getElementById('current-tags');
        
        // 显示当前标签，添加删除按钮
        currentTags.innerHTML = tags.map(tag => 
            `<span class="tag">
                <i class="fas fa-tag" style="margin-right: 4px;"></i>
                ${tag}
                <button type="button" class="delete-tag-btn" onclick="deleteTag('${imageId}', '${tag}')">
                    <i class="fas fa-times"></i>
                </button>
            </span>`
        ).join(' ');
        
        // 清空新标签输入
        document.getElementById('new-tag').value = '';
        
        // 显示对话框
        tagModal.style.display = 'block';
    }

    async function updateTag() {
        const newTag = document.getElementById('new-tag').value.trim();
        
        if (!newTag) {
            alert('请输入新标签');
            return;
        }
        
        try {
            const response = await fetch('{{ url_for("image.tag_image") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_id: currentImageId,
                    new_tag: newTag
                })
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert('标签修改成功');
                location.reload();
            } else {
                alert('修改失败: ' + result.message);
            }
        } catch (error) {
            alert('修改出错: ' + error.message);
        }
        
        closeModal('tag-modal');
    }

    function toggleRegistryFields() {
        const registryType = document.getElementById('registry-type').value;
        const dockerhubFields = document.getElementById('dockerhub-fields');
        const aliyunFields = document.getElementById('aliyun-fields');
        const tagFormatHelp = document.getElementById('tag-format-help');
        const tagFormat = document.getElementById('tag-format');

        if (registryType === 'dockerhub') {
            dockerhubFields.style.display = 'block';
            aliyunFields.style.display = 'none';
            tagFormat.placeholder = '例如: {username}/{imagename}:{version}';
            tagFormatHelp.innerHTML = 'DockerHub格式: {username}/{imagename}:{version}';
        } else {
            dockerhubFields.style.display = 'none';
            aliyunFields.style.display = 'block';
            tagFormat.placeholder = '例如: {region}/{namespace}/{imagename}:{version}';
            tagFormatHelp.innerHTML = '阿里云格式: {region}/{namespace}/{imagename}:{version}';
        }
    }

    // 添加拖动功能
    function makeDraggable(modalId) {
        const modal = document.getElementById(modalId);
        const modalContent = modal.querySelector('.modal-content');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        modalContent.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            // 只有点击标题栏或模态框空白处才能拖动
            if (e.target.closest('.modal-header') || e.target === modalContent) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                isDragging = true;
                
                // 添加正在拖动的样式
                modalContent.style.transition = 'none';
                modalContent.style.cursor = 'grabbing';
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                setTranslate(currentX, currentY, modalContent);
            }
        }

        function dragEnd(e) {
            if (isDragging) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                
                // 恢复原有样式
                modalContent.style.cursor = 'move';
            }
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate(${xPos}px, ${yPos}px)`;
        }
    }

    async function deleteTag(imageId, tag) {
        if (!confirm(`确定要删除标签 ${tag} 吗？`)) {
            return;
        }
        
        try {
            const response = await fetch('{{ url_for("image.delete_tag") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_id: imageId,
                    tag: tag
                })
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert('标签删除成功');
                location.reload();
            } else {
                alert('删除失败: ' + result.message);
            }
        } catch (error) {
            alert('删除出错: ' + error.message);
        }
    }
</script>
{% endblock %} 